#!/bin/bash

# ----------------------------------------------------------------------
# File: eos-instance-test
# Author: Andreas-Joachim Peters - CERN
# ----------------------------------------------------------------------

# ************************************************************************
# * EOS - the CERN Disk Storage System                                   *
# * Copyright (C) 2011 CERN/Switzerland                                  *
# *                                                                      *
# * This program is free software: you can redistribute it and/or modify *
# * it under the terms of the GNU General Public License as published by *
# * the Free Software Foundation, either version 3 of the License, or    *
# * (at your option) any later version.                                  *
# *                                                                      *
# * This program is distributed in the hope that it will be useful,      *
# * but WITHOUT ANY WARRANTY; without even the implied warranty of       *
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        *
# * GNU General Public License for more details.                         *
# *                                                                      *
# * You should have received a copy of the GNU General Public License    *
# * along with this program.  If not, see <http://www.gnu.org/licenses/>.*
# ************************************************************************

################################################################################
# Usage:
#
# - run full test suite:   bash> eos-instance
# - list test id's:        bash> eos-instance list
# - limit tests:           bash> eos-instance 243 258 # run 243-258 (prepare+cleanup always runs)
# - limit tests:           bash> eos-instance fuse,rain  # run only fuse+rain tests
#
################################################################################

# default values can be overwritten in /etc/sysconfig/eos
#export EOS_TEST_MAILNOTIFY=apeters@mail.cern.ch
#export EOS_TEST_GSMNOTIFY="0041764875002@mail2sms.cern.ch"

export EOS_TEST_REDIRECTOR=localhost
export EOS_TEST_FULL_REDIRECTOR=`hostname -f`
export EOS_TEST_TESTSYS=/tmp/eos-instance-test
export EOS_TEST_GSMLOCKTIME=3600
export EOS_TEST_TESTTIMESLICE=500;

firsttest=$1
lasttest=$2

################################################################################
# Check which version of XRootD we are using
################################################################################
XRD_VERS_MAJOR=$(rpm -qa | grep xrootd-client-[[:digit:]] | awk -F "-" '{print $3}' | awk -F "." '{print $1}')

if [ "${XRD_VERS_MAJOR}" -eq "3" ]; then
 XRD4=0
else
 XRD4=1
fi

if [ -e /etc/sysconfig/eos ];  then
. /etc/sysconfig/eos
fi

if [ -z "$EOS_TEST_INSTANCE" ]; then
  if [ -n "$EOS_INSTANCE_NAME" ]; then
    export EOS_TEST_INSTANCE=${EOS_INSTANCE_NAME#eos}
  else
    export EOS_TEST_INSTANCE="dev"
  fi
fi
################################################################################
mkdir -p $EOS_TEST_TESTSYS
################################################################################
# don't touch
export failed=0
export success=0
export EOSLASTLOG=$EOS_TEST_TESTSYS/test-last.log
export EOSALLCERTLOG=$EOS_TEST_TESTSYS/test-result.log
export EOSCERTLOG=$EOS_TEST_TESTSYS/test-output.log
export GSMLOCKFILE=$EOS_TEST_TESTSYS/eos-gsm.lock
export EOSTESTPID=$EOS_TEST_TESTSYS/eos-pid
export FAILFILE=$EOS_TEST_TESTSYS/eos-failed
export TIMEOUTFILE=$EOS_TEST_TESTSYS/eos-timeout
export TESTSYSFILE0K=$EOS_TEST_TESTSYS/file.0K
export TESTSYSFILE1K=$EOS_TEST_TESTSYS/file.1K
export TESTSYSFILE1M=$EOS_TEST_TESTSYS/file.1M
export TESTSYSFILE50M=$EOS_TEST_TESTSYS/file.50M
export EOSLOGBOOK=/var/log/eos/mgm/logbook.log

################################################################################
if [ "x$1" != "xlist" ]; then

if [ ! -e $TESTSYSFILE0K ]; then
echo "####################################"
echo "### Creating Test Pattern File 0K"
echo "####################################"
rm -rf $TESTSYSFILE0K >& /dev/null
touch $TESTSYSFILE0K
fi

if [ ! -e $TESTSYSFILE1K ]; then
echo "####################################"
echo "### Creating Test Pattern File 1K"
echo "####################################"
yes | dd of=$TESTSYSFILE1K bs=1k count=1
fi

CKS1K=`eos-adler32 $TESTSYSFILE1K | awk '{print $4'} | sed s/adler32=//`
echo "adler32 (1k) = $CKS1K"

if [ ! -e $TESTSYSFILE1M ]; then
echo "####################################"
echo "### Creating Test Pattern File 1M"
echo "####################################"
yes | dd of=$TESTSYSFILE1M bs=1k count=1000
fi

CKS1M=`eos-adler32 $TESTSYSFILE1M | awk '{print $4'} | sed s/adler32=//`
echo "adler32 (1M) = $CKS1M"

if [ ! -e $TESTSYSFILE50M ]; then
echo "####################################"
echo "### Creating Test Pattern File 50M"
echo "####################################"
yes | dd of=$TESTSYSFILE50M bs=1k count=50000
fi

CKS50M=`eos-adler32 $TESTSYSFILE50M | awk '{print $4'} | sed s/adler32=//`
echo "adler32 (50M) = $CKS50M"

export EOS_TEST_RAIN_DIR=$EOS_TEST_TESTSYS/rain

if [ ! -d $EOS_TEST_RAIN_DIR ]; then
echo "############################################"
echo "### Creating RAIN Dir"
echo "############################################"

mkdir -p $EOS_TEST_RAIN_DIR
dd if=/dev/urandom of=$EOS_TEST_RAIN_DIR/file1.rain bs=1552K count=1
dd if=/dev/urandom of=$EOS_TEST_RAIN_DIR/file2.rain bs=18227K count=1
dd if=/dev/urandom of=$EOS_TEST_RAIN_DIR/file3.rain bs=1M count=34
echo "############################################"
echo "### Creating Files and Patterns for IO Test"
echo "############################################"
cp $EOS_TEST_RAIN_DIR/file1.rain $EOS_TEST_RAIN_DIR/file1.io
(echo "0 524288"; echo "409600 786432"; echo "614400 1048576"; echo "1024000 1589248") >> $EOS_TEST_RAIN_DIR/file1.io.pattern
cp $EOS_TEST_RAIN_DIR/file2.rain $EOS_TEST_RAIN_DIR/file2.io
(echo "0 4194304"; echo "1048576 2097152"; echo "3145728 7340032"; echo "5242880 6291456"; echo "7340032 15728640"; echo "14680064 17825792"; echo "16777216 18664448") >> $EOS_TEST_RAIN_DIR/file2.io.pattern
cp $EOS_TEST_RAIN_DIR/file3.rain $EOS_TEST_RAIN_DIR/file3.io
(echo "0 524288"; echo "409600 786432"; echo "614400 1048576"; echo "1024000 1589248";
 echo "1589248 20971520"; echo "20971520 20973568"; echo "20972544 20975616 ";
 echo "20972544 20976640"; echo "20976640 35651584") >> $EOS_TEST_RAIN_DIR/file3.io.pattern
fi
fi

################################################################################
. /etc/rc.d/init.d/functions
echo "" > $EOSALLCERTLOG
rm -f $FAILFILE 2>/dev/null
rm -f $TIMEOUTFILE 2>/dev/null
rm -f $EOSCERTLOG 2>/dev/null
kill_child_processes() {
    pid=$(bash -c 'echo $PPID');
    if [ $1 -gt 0 ]; then
        pids=`pstree -p $1 | sed 's/(/\n(/g' | grep '(' | sed 's/(\(.*\)).*/\1/' | tr "\n" " "`;
        for name in $pids; do
            if [ $name -ne $pid ]; then
                kill -9 $name >& /dev/null
                usleep 100000
            fi
        done
    fi
}

kill_processes() {
    echo
    echo
    echo "CONTORL-C received ... aborting ..."
    echo
    pid=`cat $EOSTESTPID 2>/dev/null`;
    if [ -z "$pid" ]; then
            pid=$(bash -c 'echo $PPID');
    fi
    kill_child_processes $pid;
    exit -1;
}

################################################################################
mailnotify () {
    OK="OK" && test -e $FAILFILE && OK="FAILED"

    if [ $OK = "FAILED" ]; then
        if [ -n "$EOS_TEST_MAILNOTIFY" ]; then
          mutt -s "$EOS_TEST_INSTANCE $OK" $EOS_TEST_MAILNOTIFY < $EOSALLCERTLOG ; fi
        if [ ! -e $GSMLOCKFILE ]; then
            if [ -n "$EOS_TEST_GSMNOTIFY" ]; then
              echo "$EOS_TEST_INSTANCE failed at `date`" | mail -s "$EOS_TEST_INSTANCE $OK" $EOS_TEST_GSMNOTIFY ; \
              touch $GSMLOCKFILE; ( sleep EOS_TEST_GSMLOCKTIME; rm -rf $GSMLOCKFILE; ) >& /dev/null &
            fi;
        fi
        exit -1;
    fi
    exit 0;
}
################################################################################
(
export XROOTSYS=/usr/
export LD_LIBRARY_PATH=$XROOTSYS/lib64/:$LD_LIBRARY_PATH; export PATH=$XROOTSYS/bin:$PATH
pid=$(bash -c 'echo $PPID');
echo -n $pid >& $EOSTESTPID
################################################################################
# Library
################################################################################
showtoken () {
    echo "############### KRB 5 ##############"
    /usr/kerberos/bin/klist -5
    echo "############### X509  ##############"
    xrdgsiproxy info
    echo "####################################"
}
################################################################################
logoutput () {
    echo "----------------- Error Output --------------------";cat $EOSCERTLOG ;echo "---------------------------------------------------"
}
################################################################################
upload () {
    src=$1
    dst=$2
    shift
    shift
    echo xrdcp -np -v -f $* $src root://$EOS_TEST_REDIRECTOR/$dst >& $EOSLASTLOG ;eval $XROOTSYS/bin/xrdcp -f $* $src root://$EOS_TEST_REDIRECTOR/$dst >> $EOSCERTLOG 2>&1
}
################################################################################
download () {
    src=$1
    dst=$2
    shift
    shift
    echo xrdcp -np -v -f $* root://$EOS_TEST_REDIRECTOR/$dst $src  >& $EOSLASTLOG ;eval $XROOTSYS/bin/xrdcp -f $* root://$EOS_TEST_REDIRECTOR/$dst $src >> $EOSCERTLOG 2>&1
}
################################################################################
downloadh () {
    src=$1
    dst=$2
    shift
    shift
    echo xrdcp -np -v -f $* root://$EOS_TEST_FULL_REDIRECTOR/$dst $src  >& $EOSLASTLOG ;eval $XROOTSYS/bin/xrdcp -f $* root://$EOS_TEST_FULL_REDIRECTOR/$dst $src >> $EOSCERTLOG 2>&1
}
################################################################################
timeout() {
    echo "## TIMEOUT ##";
    exit 0;
}

meta() {
    echo xrdfs $EOS_TEST_REDIRECTOR $* >& $EOSLASTLOG ; eval $XROOTSYS/bin/xrdfs $EOS_TEST_REDIRECTOR $* >> $EOSCERTLOG 2>&1
}

eos() {
    echo eos -b $EOSROLE root://$EOS_TEST_REDIRECTOR $* >& $EOSLASTLOG; eval $XROOTSYS/bin/eos -b $EOSROLE root://$EOS_TEST_REDIRECTOR $* >> $EOSCERTLOG 2>&1
}

tpc1() {
    src=$1
    dst=$2
    echo xrdcp --tpc only root://$EOS_TEST_REDIRECTOR/$src root://$EOS_TEST_REDIRECTOR/$dst >& $EOSLASTLOG; eval $XROOTSYS/bin/xrdcp -f --tpc only root://$EOS_TEST_REDIRECTOR/$src root://$EOS_TEST_REDIRECTOR/$dst >> $EOSCERTLOG 2>&1
}

tpc2() {
    src=$1
    dst=$2
    echo xrdcopy --tpc only root://$EOS_TEST_REDIRECTOR/$src root://$EOS_TEST_REDIRECTOR/$dst >& $EOSLASTLOG; eval $XROOTSYS/bin/xrdcopy --tpc only root://$EOS_TEST_REDIRECTOR/$src root://$EOS_TEST_REDIRECTOR/$dst >> $EOSCERTLOG 2>&1
}

tgrep() {
        a=$1
        shift
        echo "eval $* | grep $a" >& $EOSLASTLOG; eval $* | grep $a >> $EOSCERTLOG 2>&1
}

stress() {
    echo xrdstress $* >& $EOSLASTLOG; eval XRD_RUNFORKHANDLER=1 xrdstress $* >> $EOSCERTLOG 2>&1
}

append() {
    echo xrdcpappend root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpappend root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

abort() {
    echo xrdcpabort root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpabort root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

extend() {
    echo xrdcpextend root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpextend root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

shrink() {
    echo xrdcpshrink root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpshrink root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

random() {
    echo xrdcprandom root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcprandom root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

truncate() {
    echo xrdcptruncate root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcptruncate root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

holes() {
    echo xrdcpholesroot://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpholes root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

backward() {
    echo xrdcpbackward root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpbackward root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

partial() {
    echo xrdcppartial root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcppartial root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

downloadrandom() {
    echo xrdcpdownloadrandom root://$EOS_TEST_REDIRECTOR/$1 >& $EOSLASTLOG; eval xrdcpdownloadrandom root://$EOS_TEST_REDIRECTOR/$1 >> $EOSCERTLOG 2>&1
}

eos_rain() {
    echo eos-rain-test $1 $2 root://$EOS_TEST_REDIRECTOR/$3 >& $EOSLASTLOG; eval eos-rain-test $1 $2 root://$EOS_TEST_REDIRECTOR/$3 >> $EOSCERTLOG 2>&1
}

eoscp_rain() {
    echo eoscp-rain-test $1 root://$EOS_TEST_REDIRECTOR/$2 >& $EOSLASTLOG; eval eoscp-rain-test $1 root://$EOS_TEST_REDIRECTOR/$2 >> $EOSCERTLOG 2>&1
}

eos_io() {
   echo eos-io-test root://$EOS_TEST_REDIRECTOR/$1 $2 >& $EOSLASTLOG; eval eos-io-test root://$EOS_TEST_REDIRECTOR/$1 $2 >> $EOSCERTLOG 2>&1
}

shell() {
    echo $* >& $EOSLASTLOG; eval $* >> $EOSCERTLOG 2>&1
}

################################################################################
testout () {
    echo Failed: $failed Success: $success
    if [ $failed -gt 0 ]; then touch $FAILFILE; fi
}
################################################################################
testcnt=0;
runtest () {
    testcnt=$[$testcnt+1];

    if [ -e $TIMEOUTFILE ]; then
        echo -n `date +"%x %X"` timeout
        failure
    else
        echo "-------------------------------------------------------------" >> $EOSCERTLOG 2>&1
        echo "# Test $testcnt: $*" >> $EOSCERTLOG 2>&1
        echo "-------------------------------------------------------------" >> $EOSCERTLOG 2>&1

        if [ "$firsttest" = "list" ]; then
          printf "# [ %-7s ]" $categorie ;
          printf " ID %02d" $testcnt;
          echo " $*"
          return
        fi

        START=$(date +%s.%N)
        echo $testcnt | awk '{printf("%04d ",$1);}'
        echo -n `date +"%x %X"` "$1"
        auth=$2
        res=$3
        renv=$4
        shift
        echo -n $*
        shift
        shift
        shift
        skip=0
        if [ $categorie != "prep" ] && [ $categorie != "clean" ]; then
          # --- if $firsttest is set and $lasttest not we assume it is a categorie list
          if [ "x$firsttest" != "x" ] && [ "x$lasttest" == "x" ]; then
            if [ "x$firsttest" = "x${firsttest/$categorie}" ] ; then
              echo
              warning "skipped" ; echo -n " ... skipped"
              echo
              skip=1
            fi
          else

          # --- skip if start-range was given
          if [ "x$firsttest" != "x" ] ; then
            if [ $testcnt -lt $firsttest ]; then
              echo
              warning "skipped" ; echo -n " ... skipped"
              echo
              skip=1
            fi
          fi
          # --- skip if end-range was given
          if [ "x$lasttest" != "x" ] ; then
            if [ $testcnt -gt $lasttest ]; then
              echo
              warning "skipped" ; echo -n " ... skipped"
              echo
              skip=1
            fi
          fi
          fi
        fi

        if [ $skip = 0 ] ; then
          if [ $auth = "krb5" ] ; then ( eval export X509_USER_CERT=/tmp/illegal X509_USER_KEY=/tmp/illegal $renv; $* ) ; ret=$?; fi
          if [ $auth = "gsi"  ] ; then ( eval export KRB5CCNAME=/tmp/illegal                                $renv; $* ) ; ret=$?; fi
          if [ $auth = "unix" ] ; then ( eval export XrdSecPROTOCOL=unix                                    $renv; $* ) ; ret=$?; fi
          if [ $auth = "sss"  ] ; then ( eval export XrdSecPROTOCOL=sss                                     $renv; $* ) ; ret=$?; fi
          echo
          if [ $res -eq 0 ] ; then if [ $ret -eq 0 ]; then success; ((success++));else failure ; ((failed++)); echo ; fi; fi
          if [ $res -eq 1 ] ; then if [ $ret -ne 0 ]; then success; ((success++));else failure ; ((failed++)); echo ; fi; fi
          if [ $res -eq 2 ] ; then success; ((success++)); fi
          END=$(date +%s.%N)
          DIFF=$(echo "$END - $START" | bc)
          echo "                         in $DIFF seconds"
        fi
        echo "--------------------------------------------------------------------------------------------------------------------"
    fi
}
################################################################################

echo "==================================================="
echo "### Testing $EOS_TEST_REDIRECTOR"
echo "==================================================="

################################################################################
# define your tests here
# runtest <info> <auth> <exports> <expect> <mode> <srcpath> <dstpath> <param>
#      <info>                  : describes what you are testing
#      <auth>                  : 'krb5','gsi','unix','sss' - choose krb5 or X509 authentication [ you have to create both tokens beforehand ]
#      <env>                   : can be used to set the execution environment env <env> "
#      <expect>                : 0 or 1 => 0 - you expect the command works , 1 - you expect that the command failes, 2 - you run the command but it can fail or not, that is expected
#      <mode>                  : upload|download|downloadh|meta|eos|stress|abort|extend|shrink|random|truncate|holes|backward|partial|downloadrandom|tpc1|tpc2|shell|eoscp_rain|eos_rain|eos_io :
#                                self explaining - meta executes command via xrd shell, eos via eos shell, stress runs xrdstress, abort runs xrdcpabort ...
#      <srcpath,dstpath>       : is a local '/...' or remote '/eos/...' path
#      <param>                 : opaque information passed ... '&' has to be escaped !!!!
################################################################################

################################################################################
#xrdgsiproxy init >>& $EOSCERTLOG
showtoken >> $EOSCERTLOG 2>&1


################################################################################
# Preparation
################################################################################
# ------------------------------------------------------------------------------
categorie="prep"
# ------------------------------------------------------------------------------
runtest "### Access    " unix 2 "" eos "access rm stall r"
runtest "### Access    " unix 2 "" eos "access rm redirect"
runtest "### Access    " unix 2 "" eos "access unban user nobody"
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/"
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/stress/"
runtest "### Cleanup   " unix 2 "" eos attr rm sys.forced.blockchecksum /eos/$EOS_TEST_INSTANCE/test/
runtest "### Cleanup   " unix 2 "" eos attr rm sys.forced.blocksize /eos/$EOS_TEST_INSTANCE/test/
runtest "### Cleanup   " unix 2 "" eos attr rm sys.forced.checksum /eos/$EOS_TEST_INSTANCE/test/
runtest "### Cleanup   " unix 2 "" eos attr rm sys.forced.layouts /eos/$EOS_TEST_INSTANCE/test/
runtest "### Cleanup   " unix 2 "" eos attr rm sys.forced.nstripes /eos/$EOS_TEST_INSTANCE/test/
runtest "### Cleanup   " unix 2 "" eos attr rm sys.forced.space /eos/$EOS_TEST_INSTANCE/test/
runtest "### Cleanup   " unix 2 "" eos attr rm sys.versioning /eos/$EOS_TEST_INSTANCE/test/
runtest "### Quota     " unix 0 "" eos quota set -u 99 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
runtest "### Quota     " unix 0 "" eos quota set -u 100 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
runtest "### Quota     " unix 0 "" eos quota set -u 2 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
runtest "### Quota     " unix 0 "" eos quota set -u 3 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
runtest "### Quota     " unix 0 "" eos quota set -u 2000 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
runtest "### Mkdir     " unix 0 "" eos mkdir "-p" "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### Rm        " unix 0 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### Chmod     " unix 0 "" eos chmod "755" "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### Motd      " unix 0 "" eos motd
runtest "### Help      " unix 0 "" eos "help | grep \"Display this text\""
################################################################################
# Upload,Download,Stat,Rename
################################################################################
# ------------------------------------------------------------------------------
categorie="core"
# ------------------------------------------------------------------------------
runtest "### Upload    " unix 1 "" upload    "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-ODeos.space=default"
runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest"
runtest "### Upload    " unix 0 "" upload    "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-ODeos.space=default"
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Stat      " unix 1 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.1"
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Part.Dwld " unix 0 "" partial   "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Download  " unix 1 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.1"
runtest "### Dowl Lfn  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/enoent" "-OSeos.lfn=/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Dowl Lfn  " unix 1 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/enoent" "-OSeos.lfn=/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.1"
runtest "### Dowl Pfx  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/test/instancetest/passwd" "-OSeos.prefix=/eos/$EOS_TEST_INSTANCE/"
runtest "### Dowl Pfx  " unix 1 "" download  "$EOS_TEST_TESTSYS/dumpit" "/test/instancetest/passwd" "-OSeos.prefix=/eos/faulty/"
runtest "### Find      " unix 0 "" eos find "-f --count /eos/$EOS_TEST_INSTANCE/test/ | grep nfiles=1"
runtest "### Rem       " unix 1 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.1"
runtest "### FileInfo  " unix 1 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.1"
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Whoami    " unix 0 "" eos "whoami | grep authz:unix | grep uid=0"
runtest "### Who       " unix 0 "" eos "who | grep root"
runtest "### Rem       " unix 0 "" eos rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Rename    " unix 1 "" eos "file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.rename"
runtest "### Upload    " unix 0 "" upload    "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-ODeos.space=default"
runtest "### Chmod     " unix 0 "" eos chmod "755" "/eos/$EOS_TEST_INSTANCE/test/instancetest"
runtest "### Rename    " unix 1 "EOSROLE='-r 99 99'" eos file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.rename
runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest"
runtest "### Rename    " unix 0 "" eos file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.rename

runtest "### Mkdir     " unix 0 "" eos "mkdir /eos/$EOS_TEST_INSTANCE/test/instancetest/rename.dir"
runtest "### Rename    " unix 1 "" eos "file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/rename.dir /eos/$EOS_TEST_INSTANCE/test/instancetest/rename.dir/myself"
runtest "### Rename    " unix 1 "" eos "file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/rename.dir /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.rename"
runtest "### Rename    " unix 1 "" eos "file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/rename.dir.missing /eos/$EOS_TEST_INSTANCE/test/instancetest/rename"
runtest "### Rename    " unix 0 "" eos "file rename /eos/$EOS_TEST_INSTANCE/test/instancetest/rename.dir /eos/$EOS_TEST_INSTANCE/test/instancetest/rename"
runtest "### Rem       " unix 0 "" eos rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.rename"
runtest "### Upload    " unix 0 "" upload    "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-ODeos.space=default"
runtest "### Rmdir     " unix 0 "" eos rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/rename"

runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/a\&b"
runtest "### Rmdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/a\&b"
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/a\&b"
runtest "### Rmrf      " unix 0 "" eos rm -rf "/eos/$EOS_TEST_INSTANCE/test/instancetest/a\&b"

runtest "### MkSpace   " unix 0 "" eos "space define __test__"
runtest "### SetSpace  " unix 0 "" eos "space set __test__ on "
runtest "### RmSpace   " unix 0 "" eos "space rm __test__"

runtest "### MkGroup   " unix 0 "" eos "group set __test__ on"
runtest "### RmGroup   " unix 0 "" eos "group rm __test__"

runtest "### MkNode    " unix 0 "" eos "node set __test__ on"
runtest "### RmNode    " unix 0 "" eos "node rm __test__"

# --------------------------
# Constrain minimum file size
# --------------------------
runtest "### Mkdir     " unix 0 "" eos "mkdir /eos/$EOS_TEST_INSTANCE/test/instancetest/minsize"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.minsize=1000000 /eos/$EOS_TEST_INSTANCE/test/instancetest/minsize
runtest "### Upload    " unix 1 "" upload   "/etc/group" "/eos/$EOS_TEST_INSTANCE/test/instancetest/minsize/f1"
runtest "### Upload    " unix 0 "" upload   "$TESTSYSFILE1M" "/eos/$EOS_TEST_INSTANCE/test/instancetest/minsize/f1"
runtest "### Rem       " unix 0 "" eos rm -r "/eos/$EOS_TEST_INSTANCE/test/instancetest/minsize"

# --------------------------
# Constrain maximum file size
# --------------------------
runtest "### Mkdir     " unix 0 "" eos "mkdir /eos/$EOS_TEST_INSTANCE/test/instancetest/maxsize"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.maxsize=1000000 /eos/$EOS_TEST_INSTANCE/test/instancetest/maxsize
runtest "### Upload    " unix 1 "" upload   "$TESTSYSFILE1M" "/eos/$EOS_TEST_INSTANCE/test/instancetest/maxsize/f1"
runtest "### Upload    " unix 0 "" upload   "/etc/group" "/eos/$EOS_TEST_INSTANCE/test/instancetest/maxsize/f1"
runtest "### Rem       " unix 0 "" eos rm -r "/eos/$EOS_TEST_INSTANCE/test/instancetest/maxsize"

# --------------------------
# Control-C
# --------------------------
runtest "### Abort     " unix 1 "" abort /eos/$EOS_TEST_INSTANCE/test/instancetest/abort
runtest "### FileInfo  " unix 1 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/abort"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/abort"
# --------------------------
# Extend a file via truncate
# --------------------------
runtest "### Extend    " unix 0 "" extend /eos/$EOS_TEST_INSTANCE/test/instancetest/extend
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/extend"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/extend"
# --------------------------
# Shrink a file via truncate
# --------------------------
runtest "### Shrink    " unix 0 "" shrink /eos/$EOS_TEST_INSTANCE/test/instancetest/shrink
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/shrink"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/shrink"
# --------------------------
# Write file in random order
# --------------------------
runtest "### Random    " unix 0 "" random /eos/$EOS_TEST_INSTANCE/test/instancetest/random
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/random"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/random"
# --------------------------
# Extend file and rewrite the beginning
# --------------------------
runtest "### Truncate  " unix 0 "" truncate /eos/$EOS_TEST_INSTANCE/test/instancetest/truncate
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/truncate"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/truncate"
# --------------------------
# Expand file several times
# --------------------------
runtest "### holes     " unix 0 "" holes /eos/$EOS_TEST_INSTANCE/test/instancetest/holes
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/holes"
runtest "### backward  " unix 0 "" backward  /eos/$EOS_TEST_INSTANCE/test/instancetest/holes
runtest "### downrnd   " unix 0 "" downloadrandom  /eos/$EOS_TEST_INSTANCE/test/instancetest/holes
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/holes"
# --------------------------
runtest "### Attr      " unix 0 "" eos attr set sys.forced.checksum=adler /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### UploadCks " unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k" "-ODeos.checksum=$CKS1K"
runtest "### FileInfo  " unix 0 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k -m | grep nrep=1"
runtest "### UploadCks " unix 0 "" upload    "$TESTSYSFILE0K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/good-checksum0k" "-ODeos.checksum=00000001"
runtest "### Rem       " unix 0 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/good-checksum0k"
runtest "### UploadCks " unix 1 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k" "-ODeos.checksum=00000000"
runtest "### FileInfo  " unix 1 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k -m | grep nrep=0"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k"
runtest "### UploadCks " unix 1 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k" "-ODeos.checksum=00000000"
runtest "### FileInfo  " unix 1 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k -m | grep nrep=0"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-checksum1k"
runtest "### Attr      "  unix 0 "" eos attr rm sys.forced.checksum /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### UploadSz  "  unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-size1k" "-ODeos.targetsize=1024"
runtest "### FileInfo  " unix 0 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-size1k -m | grep nrep=1"
runtest "### UploadSz  " unix 1 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-size1k" "-ODeos.targetsize=1000"
runtest "### FileInfo  " unix 1 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-size1k -m | grep nrep=0"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/faulty-size1k"

# -------------------------------
# Verify sys.owner.auth behaviour
# -------------------------------
runtest "### Mkdir     " unix 0 "" eos "mkdir /eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/"
runtest "### Attr      " unix 0 "" eos "attr set sys.owner.auth=* /eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth"
runtest "### Chown     " unix 0 "" eos chown 2000:2001 "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth"
runtest "### Upload-L3 " unix 0 "" upload   "/etc/group" "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/l1/l2/l3/f1"
runtest "### Vfy-Uid   " unix 0 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/l1/l2/l3/f1 -m | grep uid=2000"
runtest "### Vfy-Gid   " unix 0 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/l1/l2/l3/f1 -m | grep gid=2001"
runtest "### Upload-L1 " unix 0 "" upload   "/etc/group" "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/f1"
runtest "### Vfy-Uid   " unix 0 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/f1 -m | grep uid=2000"
runtest "### Vfy-Gid   " unix 0 "" eos fileinfo "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/f1 -m | grep gid=2001"
runtest "### Rem       " unix 0 "" eos rm -r "/eos/$EOS_TEST_INSTANCE/test/instancetest/owner-auth/"

################################################################################
# VERSION
################################################################################
runtest "### Version   " unix 0 "" eos "version | grep EOS_INSTANCE"
runtest "### Version   " unix 0 "" eos "version | grep EOS_CLIENT_VERSION"
runtest "### Version   " unix 0 "" eos "version | grep EOS_SERVER_VERSION"
runtest "### Version   " unix 0 "" eos "version -m | grep xrootd.version"
################################################################################
# COMMENT
################################################################################
runtest "### Comment         " unix 0 "" eos "whoami --comment \"Hello World\""
runtest "### Comment         " unix 0 "" shell grep $EOSLOGBOOK -e \"Hello World\"
runtest "### Comment Proto   " unix 0 "" eos "fs ls --comment \"Hello Proto World\""
runtest "### Comment Proto   " unix 0 "" shell grep $EOSLOGBOOK -e \"Hello Proto World\"
################################################################################
# ACCESS
################################################################################
#-----------------------------
# Access ban
#-----------------------------
runtest "### Access    " unix 0 "" eos "access ban user nobody"
# takes long
#runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
#runtest "### Download  " unix 1 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-OSeos.ruid=99" "-DITransactionTimeout 1"
runtest "### Access    " unix 0 "" eos "access ls | grep nobody"
runtest "### Access    " unix 0 "" eos "access unban user nobody"
runtest "### Access    " unix 1 "" eos "access ls | grep nobody"
#-----------------------------
# Access stall
#-----------------------------
runtest "### Access    " unix 0 "" eos "access set stall 1 r"
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
runtest "### Download  " unix 1 "" eosssh-timeout -t 3 download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-OSeos.ruid=99"
runtest "### Access    " unix 0 "" eos "access ls | grep \"r:\* => 1\""
runtest "### Access    " unix 0 "" eos "access rm stall r"
runtest "### Access    " unix 1 "" eos "access ls | grep \"r:\* => 1\""
#-----------------------------
# Access redirect
#-----------------------------
runtest "### Access    " unix 0 "" eos "access set redirect foo.senf"
runtest "### Download  " unix 1 "" downloadh  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd" "-DIFirstConnectTimeout 2 -DIConnectTimeout 2 -DIReconnectWait 1 -DIMaxRedirectCnt 1"
runtest "### Access    " unix 0 "" eos "access ls | grep foo"
runtest "### Access    " unix 0 "" eos "access rm redirect"
runtest "### Access    " unix 1 "" eos "access ls | grep foo"
runtest "### Rm        " unix 0 "" eos "rm /eos/$EOS_TEST_INSTANCE/test/instancetest/passwd"
################################################################################
# Quota Tests
################################################################################
# ------------------------------------------------------------------------------
categorie="quota"
# ------------------------------------------------------------------------------
$XROOTSYS/bin/eos -b space status default | grep quota | grep on >& /dev/null 2>&1
if [ $? -eq 0 ]; then
# --------------------------
# if quota is enabled
# --------------------------
runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest"
runtest "### Quota     " unix 0 "" eos quota set -u 99 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1
runtest "### Upload    " unix 0 "" upload "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.quota" "-ODeos.ruid=99" "-DITransactionTimeout 30"
runtest "### Quota     " unix 0 "" eos quota set -u 99 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
runtest "### Upload    " unix 0 "" upload "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.quota" "-ODeos.ruid=99" "-DITransactionTimeout 30"
runtest "### Quota     " unix 0 "" eos quota set -u 99 -p /eos/$EOS_TEST_INSTANCE/test -v 1 -i 1M
runtest "### Upload    " unix 1 "" upload "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.quota" "-ODeos.ruid=99" "-DITransactionTimeout 30"
runtest "### Rem       " unix 2 "" eos rm    "/eos/$EOS_TEST_INSTANCE/test/instancetest/passwd.quota"
runtest "### Quota     " unix 0 "" eos quota set -u 99 -p /eos/$EOS_TEST_INSTANCE/test -v 1T -i 1M
fi
################################################################################
# RECYCLE BIN TEST
################################################################################
# ------------------------------------------------------------------------------
categorie="recycle"
# ------------------------------------------------------------------------------
recyclesize=`$XROOTSYS/bin/eos -b $EOSROLE root://$EOS_TEST_REDIRECTOR recycle -m | grep maxbytes | awk '{print $3}' | sed s/maxbytes=//`
recycletime=`$XROOTSYS/bin/eos -b $EOSROLE root://$EOS_TEST_REDIRECTOR recycle -m | grep lifetime | awk '{print $6}' | sed s/lifetime=//`
test -z $recyclesize && recyclesize=0
test -z $recycletime && recycletime=0

if [ $recyclesize -eq 0 ] ; then
runtest "### Recycle   " unix 0 "" eos quota set -g 99 -v 100G -i 10M /eos/$EOS_TEST_INSTANCE/proc/recycle/
fi

if [ $recycletime -eq 0 ]; then
runtest "### Recycle   " unix 0 "" eos recycle config --lifetime 86400
fi

runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest"
runtest "### Mkdir     " unix 0 "" eos mkdir "-p" "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle"
runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle"
runtest "### Recycle   " unix 0 "" eos recycle config --add-bin /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle
runtest "### Upload    " unix 0 "" upload "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle"
runtest "### Rem       " unix 0 "" eos rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle"
runtest "### Find      " unix 0 "" eos find -f /eos/$EOS_TEST_INSTANCE/proc/recycle/ | grep passwd.recycle | wc -l |grep -w 1
runtest "### Recycle-Ls" unix 0 "" eos recycle ls | grep /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle | wc -l | grep -w 1
runtest "### Restore   " unix 1 "" eos recycle restore `$XROOTSYS/bin/eos -b root://$EOS_TEST_REDIRECTOR recycle ls -g | grep /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle | awk '{print $10}' | tail -1`
runtest "### Restore   " unix 0 "EOSROLE='-r 3 4'" eos recycle restore `$XROOTSYS/bin/eos -b root://$EOS_TEST_REDIRECTOR recycle ls -g | grep /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle | awk '{print $10}' | tail -1`
runtest "### Download  " unix 0 "" download  "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle"
runtest "### Rem       " unix 0 "" eos rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle"
runtest "### Upload    " unix 0 "" upload "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle"
runtest "### Restore   " unix 1 "EOSROLE='-r 3 4'" eos recycle restore `$XROOTSYS/bin/eos -b  root://$EOS_TEST_REDIRECTOR recycle ls -g | grep /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle | awk '{print $10}' | tail -1`
runtest "### Restore   " unix 0 "EOSROLE='-r 3 4'" eos recycle restore -f `$XROOTSYS/bin/eos -b root://$EOS_TEST_REDIRECTOR recycle ls -g | grep /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle/passwd.recycle | awk '{print $10}' | tail -1`
runtest "### Recycle   " unix 0 "" eos recycle config --remove-bin /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle
runtest "### Rem       " unix 0 "" eos rm -r /eos/$EOS_TEST_INSTANCE/test/instancetest/recycle

################################################################################
# STRESS
################################################################################
## -----------------------------------------------------------------------------
categorie="stress"
# ------------------------------------------------------------------------------
runtest "### Chmod      " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/"
runtest "### Attr Set   " unix 0 "" eos attr set default=replica "/eos/$EOS_TEST_INSTANCE/test"
runtest "### Stress Wpp " unix 0 "" stress "-d root://localhost//eos/$EOS_TEST_INSTANCE/test -o wr -f 50 -s 1KB -n stress -j 10 -c -p"
runtest "### Stress Wp  " unix 0 "" stress "-d root://localhost//eos/$EOS_TEST_INSTANCE/test -o wr -f 50 -s 1KB -n stress -j 10 -c "
runtest "### Find       " unix 0 "" eos find "-f --count /eos/$EOS_TEST_INSTANCE/test/ | grep nfiles=100"
runtest "### Stress Rp  " unix 0 "" stress "-d root://localhost//eos/$EOS_TEST_INSTANCE/test -o rd -f 50 -s 1KB -n stress -j 10 -c"
runtest "### Stress Rpp " unix 0 "" stress "-d root://localhost//eos/$EOS_TEST_INSTANCE/test -o rd -f 50 -s 1KB -n stress -j 10 -c -p"
runtest "### Cleanup    " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/stress/*"
runtest "### Ls        " unix 0 "" eos ls "/eos/$EOS_TEST_INSTANCE/test | grep [a-z] | wc -l | grep -w 2"
runtest "### Ls        " unix 0 "" eos ls -l "/eos/$EOS_TEST_INSTANCE/test | grep ^d| wc -l | grep -w 2"
runtest "### Ls        " unix 0 "" eos ls -la "/eos/$EOS_TEST_INSTANCE/test | grep ^d| wc -l | grep -w 4"
runtest "### Find      " unix 0 "" eos find -d "/eos/$EOS_TEST_INSTANCE/test | grep eos | wc -l | grep -w 3"

################################################################################
# ATTRIBUTES
###################################################A############################
runtest "### Attr Set  " unix 0 "" eos attr set default=replica "/eos/$EOS_TEST_INSTANCE/test"
runtest "### Attr Ls   " unix 0 "" eos attr ls "/eos/$EOS_TEST_INSTANCE/test | grep sys | wc -l | grep -w 5"
runtest "### Attr Get  " unix 0 "" eos attr get "sys.forced.space /eos/$EOS_TEST_INSTANCE/test  | grep default"
runtest "### Attr Rm   " unix 0 "" eos attr rm  "sys.forced.blocksize /eos/$EOS_TEST_INSTANCE/test"
runtest "### Attr Rm   " unix 0 "" eos attr rm  "sys.forced.checksum /eos/$EOS_TEST_INSTANCE/test"
runtest "### Attr Rm   " unix 0 "" eos attr rm  "sys.forced.layout /eos/$EOS_TEST_INSTANCE/test"
runtest "### Attr Rm   " unix 0 "" eos attr rm  "sys.forced.nstripes /eos/$EOS_TEST_INSTANCE/test"
runtest "### File Touch" unix 0 "" eos file touch "/eos/$EOS_TEST_INSTANCE/test/file"
runtest "### Attr Set  " unix 0 "" eos attr set user.attr.test=foo "/eos/$EOS_TEST_INSTANCE/test/file"
runtest "### Attr Get  " unix 0 "" eos attr get user.attr.test "/eos/$EOS_TEST_INSTANCE/test/file | grep foo"
runtest "### Attr Get  " unix 1 "" eos attr get user.attr.bar "/eos/$EOS_TEST_INSTANCE/test/file | grep foo"
runtest "### Attr Ls   " unix 0 "" eos attr ls "/eos/$EOS_TEST_INSTANCE/test/file | grep foo"
runtest "### Attr Rm   " unix 0 "" eos attr rm user.attr.test "/eos/$EOS_TEST_INSTANCE/test/file"
runtest "### Attr Rm   " unix 1 "" eos attr rm user.attr.test "/eos/$EOS_TEST_INSTANCE/test/file"
runtest "### Rm        " unix 0 "" eos rm "/eos/$EOS_TEST_INSTANCE/test/file"

################################################################################
# FIND
################################################################################
#runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest"
#runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/a"
#runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/b"
#runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/c"
#runtest "### Mkdir     " unix 0 "" eos touch "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/a.txt"
#runtest "### Mkdir     " unix 0 "" eos touch "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/b.txt"
#runtest "### Mkdir     " unix 0 "" eos touch "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/c.txt"
#runtest "### Chmod     " unix 0 "" eos chmod "755" "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/c"
#runtest "### Chown     " unix 0 "" eos chown 0:0 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest"
#runtest "### Chown     " unix 0 "" eos chown 0:0 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/a"
#runtest "### Chown     " unix 0 "" eos chown 0:0 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/b"
#runtest "### Chown     " unix 0 "" eos chown 99:99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/c"
#runtest "### Chown     " unix 0 "" eos chown 0:0 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/a.txt"
#runtest "### Chown     " unix 0 "" eos chown 0:0 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/b.txt"
#runtest "### Chown     " unix 0 "" eos chown 99:99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/c.txt"
#runtest "### Find      " unix 0 "" eos find -d -flag 755 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 1"
#runtest "### Find      " unix 0 "" eos find -d -nflag 755 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 3"
#runtest "### Find      " unix 0 "" eos find -d -uid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 1"
#runtest "### Find      " unix 0 "" eos find -d -nuid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 3"
#runtest "### Find      " unix 0 "" eos find -d -gid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 1"
#runtest "### Find      " unix 0 "" eos find -d -ngid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 3"
#runtest "### Find      " unix 0 "" eos find -f -uid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 1"
#runtest "### Find      " unix 0 "" eos find -f -nuid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 2"
#runtest "### Find      " unix 0 "" eos find -f -gid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 1"
#runtest "### Find      " unix 0 "" eos find -f -ngid 99 "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 2"
#runtest "### Attr Set   " unix 0 "" eos attr set sys.test=abc "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/a.txt"
#runtest "### Attr Set   " unix 0 "" eos attr set sys.test=def "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/b.txt"
#runtest "### Attr Set   " unix 0 "" eos attr set sys.test=def "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest/c.txt"
#runtest "### Find      " unix 0 "" eos find -f -x sys.test=abc "/eos/$EOS_TEST_INSTANCE/test/instancetest/findtest | wc -l | grep -w 1"

################################################################################
# WFE
################################################################################
runtest "### Space     " unix 0 "" eos space config "default space.wfe=on"
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Touch     " unix 0 "" eos touch "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe/test1.dat"
runtest "### Prepare   " unix 0 "" meta prepare "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe/test1.dat\?eos.ruid=99\&eos.rgid=99 | wc -l | grep -w 0"
runtest "### Chmod     " unix 0 "" eos chmod "755" "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:99:p "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Attr      " unix 0 "" eos attr set sys.workflow.sync::prepare.default=test "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Prepare   " unix 0 "" meta prepare "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe/test1.dat\?eos.ruid=99\&eos.rgid=99 2>&1 | grep permission"
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:99:pw "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Prepare   " unix 0 "" meta prepare "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe/test1.dat\?eos.ruid=99\&eos.rgid=99"
runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:99:p "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Prepare   " unix 0 "" meta prepare "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe/test1.dat\?eos.ruid=99\&eos.rgid=99"
runtest "### Attr      " unix 0 "" eos attr rm sys.acl "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe"
runtest "### Prepare   " unix 0 "" meta prepare "/eos/$EOS_TEST_INSTANCE/test/instancetest/wfe/test1.dat\?eos.ruid=0\&eos.rgid=0"
runtest "### Space     " unix 0 "" eos space config "default space.wfe=off"

################################################################################
# ACL
###################################################A############################
categorie="acl"
runtest "### Mkdir   " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl ls  " unix 1 "" eos acl -l "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl set " unix 0 "" eos acl u:daemon=rwx "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl ls  " unix 0 "" eos acl -l "/eos/$EOS_TEST_INSTANCE/test/acl" | grep "u:daemon:rwx"
runtest "### Acl upd " unix 0 "" eos acl u:daemon:+\!d+\!u+q+c "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl ls  " unix 0 "" eos acl -l "/eos/$EOS_TEST_INSTANCE/test/acl" | grep "u:daemon:rwx!d!uqc"
runtest "### Acl upd " unix 0 "" eos acl u:daemon:-x-\!d-\!u-c "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl ls  " unix 0 "" eos acl -l "/eos/$EOS_TEST_INSTANCE/test/acl" | grep "u:daemon:rwq"
runtest "### Acl set " unix 0 "" eos acl u:daemon=rw+d+u "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl ls  " unix 0 "" eos acl -l "/eos/$EOS_TEST_INSTANCE/test/acl" | grep "u:daemon:rw+d+u"
runtest "### Acl upd " unix 0 "" eos acl u:daemon:-r-w-+d-+u "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Acl ls  " unix 1 "" eos acl -l "/eos/$EOS_TEST_INSTANCE/test/acl"
runtest "### Rmdir   " unix 0 "" eos rmdir "/eos/$EOS_TEST_INSTANCE/test/acl"

################################################################################
# NAMESPACE
################################################################################
# ------------------------------------------------------------------------------
categorie="ns"
# ------------------------------------------------------------------------------
runtest "### Cd        " unix 1 "" eos cd /__dont_exists
runtest "### Cd        " unix 0 "" eos cd /eos/$EOS_TEST_INSTANCE/test
runtest "### Ls        " unix 1 "" eos ls /__dont_exist

runtest "### Chmod     " unix 0 "" eos chmod 700 /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Ls        " unix 1 "EOSROLE='-r 99 99'" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Ls        " unix 0 "" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Attr      " unix 1 "" eos attr set sys.acl=illegal /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:nobody:rx /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Upload    " unix 1 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k" "-ODeos.ruid=99\&eos.rgid=99"
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:nobody:rwox /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Upload    " unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k" "-ODeos.ruid=99\&eos.rgid=99"
runtest "### Upload    " unix 1 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k" "-ODeos.ruid=99\&eos.rgid=99"
runtest "### Rm        " unix 1 "EOSROLE='-r 99 99'" eos rm /eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:nobody:rwx,u:100:rwx /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Upload    " unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k" "-ODeos.ruid=99\&eos.rgid=99"
runtest "### Upload    " unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.100.1k" "-ODeos.ruid=100\&eos.rgid=100"
runtest "### Chmod     " unix 0 "" eos chmod 777 /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:nobody:rwox /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Rm        " unix 1 "EOSROLE='-r 99 99'" eos rm /eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:nobody:rwx!d /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Rm        " unix 1 "EOSROLE='-r 99 99'" eos rm /eos/$EOS_TEST_INSTANCE/test/instancetest/file.100.1k
runtest "### Rm        " unix 0 "EOSROLE='-r 99 99'" eos rm /eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:100:rwx+d,g:nobody:rwx!d /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Rm        " unix 0 "EOSROLE='-r 100 99'" eos rm /eos/$EOS_TEST_INSTANCE/test/instancetest/file.100.1k
runtest "### Attr      " unix 0 "" eos attr rm sys.acl /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Attr      " unix 0 "" eos attr set sys.acl=u:nobody:rwx!u /eos/$EOS_TEST_INSTANCE/test/instancetest
runtest "### Upload    " unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k" "-ODeos.ruid=99\&eos.rgid=99"
runtest "### Update    " unix 1 "" append    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.1k\?eos.ruid=99\&eos.rgid=99"
runtest "### Chmod     " unix 0 "" eos chmod 755 /eos/$EOS_TEST_INSTANCE/test/instancetest/
runtest "### Attr      " unix 0 "" eos attr rm sys.acl /eos/$EOS_TEST_INSTANCE/test/instancetest/

# ------------------------------------------------------------------------------
categorie="symlink"
# ------------------------------------------------------------------------------
runtest "### Mkdir     " unix 0 "" eos mkdir /eos/$EOS_TEST_INSTANCE/test/instancetest/ref/
runtest "### Touch     " unix 0 "" eos touch /eos/$EOS_TEST_INSTANCE/test/instancetest/ref/touch
runtest "### Symlink-d" unix 0 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/symdir /eos/$EOS_TEST_INSTANCE/test/instancetest/ref
runtest "### Symlink-r" unix 0 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/symrel2 ../../test/instancetest/ref/
runtest "### Symlink   " unix 0 "" eos stat /eos/$EOS_TEST_INSTANCE/test/instancetest/symrel2/touch
runtest "### Symlink-r" unix 0 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/symrel1 ../instancetest/ref/
runtest "### Symlink   " unix 0 "" eos stat /eos/$EOS_TEST_INSTANCE/test/instancetest/symrel1/touch
runtest "### Symlink-f" unix 0 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/whoami /eos/$EOS_TEST_INSTANCE/test/instancetest/ref/touch
runtest "### Symlink-E" unix 1 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/whoami /eos/$EOS_TEST_INSTANCE/proc/whoami
runtest "### Symlink-E" unix 1 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/symdir /eos/$EOS_TEST_INSTANCE/test/instancetest/ref
runtest "### Symlink   " unix 0 "" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/symdir/touch
runtest "### Symlink   " unix 0 "" eos stat /eos/$EOS_TEST_INSTANCE/test/instancetest/whoami
runtest "### Symlink   " unix 0 "" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/whoami
runtest "### Symlink-L" unix 0 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/fwd-loop /eos/$EOS_TEST_INSTANCE/bwd-loop
runtest "### Symlink-L" unix 0 "" eos ln /eos/$EOS_TEST_INSTANCE/test/instancetest/bwd-loop /eos/$EOS_TEST_INSTANCE/fwd-loop
runtest "### Symlink-L" unix 1 "" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/bwd-loop
runtest "### Symlink-L" unix 1 "" eos ls /eos/$EOS_TEST_INSTANCE/test/instancetest/fwd-loop

# ------------------------------------------------------------------------------
categorie="tag"
# ------------------------------------------------------------------------------
runtest "### Mkdir     " unix 0 "" eos mkdir /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/
runtest "### Touch     " unix 0 "" eos touch /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch
runtest "### Tag       " unix 0 "" eos file tag /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch +1
runtest "### Tag       " unix 1 "" eos file tag /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch +1
runtest "### Tag       " unix 0 "" eos file tag /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch ~1
runtest "### Tag       " unix 0 "" eos file tag /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch ~1
runtest "### Tag       " unix 0 "" eos file tag /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch -1
runtest "### Tag       " unix 1 "" eos file tag /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch -1
runtest "### Rm        " unix 0 "" eos rm /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/touch
runtest "### Rmdir     " unix 0 "" eos rmdir /eos/$EOS_TEST_INSTANCE/test/instancetest/tag/

# --------------------------
# Parallel sockets (does not work currently with 3.1.0 clients)
# --------------------------
#runtest "### UploadP   " unix 0 "" upload  "$TESTSYSFILE50M" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.50k" "-S10"
#runtest "### Download  " unix 0 "" download "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.50k"
#runtest "### DownloadP " unix 0 "" download "$EOS_TEST_TESTSYS/dumpit" "/eos/$EOS_TEST_INSTANCE/test/instancetest/file.50k" "-S10"

################################################################################
# eoscp tests
################################################################################
# ------------------------------------------------------------------------------
categorie="eoscp"
# ------------------------------------------------------------------------------
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp -d /etc/passwd /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp -
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp.1
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp root://$EOS_TEST_REDIRECTOR//eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp.1 root://$EOS_TEST_REDIRECTOR//eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp.2
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp root://$EOS_TEST_REDIRECTOR//eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/passwd.eoscp.2 /tmp/
runtest "### eoscp     " unix 1 "EOSROLE='-r 0 0'" eos cp /etc/passwd /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/a/b/c/
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp -p /etc/passwd /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/a/b/c/
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp -p /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp/* /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp2
runtest "### eoscp     " unix 0 "EOSROLE='-r 0 0'" eos cp -r /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp3
runtest "### eoscp     " unix 0 "" rm /tmp/passwd.eoscp.2
runtest "### eoscp     " unix 0 "" eos rm -r /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp
runtest "### eoscp     " unix 0 "" eos rm -r /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp2
runtest "### eoscp     " unix 0 "" eos rm -r /eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp3

################################################################################
# eos FUSE tests
################################################################################
# ------------------------------------------------------------------------------
categorie="fuse"
# ------------------------------------------------------------------------------
if [ -e "/eos/$EOS_TEST_INSTANCE" ];
then
echo "### Running FUSE tests ... disabling krb5/x509 ..."
export X509_USER_PROXY=/tmp/invalid
export KRB5CCNAME=/tmp/invalid

runtest "### Mkdir     " unix 0 "" eos mkdir "-p" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### Chmod     " unix 0 "" eos chmod 755 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE cp   " unix 1 "" shell cp "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k"
runtest "### FUSE touch" unix 0 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/touch"
runtest "### FUSE cat  " unix 0 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/touch"
runtest "### FUSE rm   " unix 0 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/touch"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE cp   " unix 0 "" shell cp "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k"
runtest "### Chmod     " unix 0 "" eos chmod 755 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE mkdr " unix 1 "" shell mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.forbidden"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE mkdr " unix 0 "" shell mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### FUSE mkdr " unix 0 "" shell mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed2"
runtest "### Chmod     " unix 0 "" eos chmod 755 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE mkdr " unix 1 "" shell rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE mkdr " unix 0 "" shell rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### FUSE chmd " unix 1 "" shell chmod 755 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/"
runtest "### Chown     " unix 0 "" eos chown 2:2 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE chmd " unix 0 "" shell chmod 555 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE mv   " unix 1 "" shell mv "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k.forbidden"
runtest "### FUSE chmd " unix 0 "" shell chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse"
runtest "### FUSE mv   " unix 0 "" shell mv "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k.forbidden"
runtest "### Chmod     " unix 0 "" eos chmod 555 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed2"
runtest "### FUSE mv   " unix 1 "" shell mv "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k.forbidden" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed2"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed2"
runtest "### FUSE mv   " unix 0 "" shell mv "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file.1k.forbidden" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed2"
runtest "### FUSE mv   " unix 0 "" shell mv "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed2" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### Chmod     " unix 0 "" eos chmod 555 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### Chmod     " unix 0 "" eos chmod 555 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/"
runtest "### rm        " unix 1 "" shell rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### rm        " unix 1 "" shell rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed/file.1k.forbidden"
runtest "### rmdir     " unix 1 "" shell rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed/"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed"
runtest "### rmdir     " unix 1 "" shell rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed/"
runtest "### rm        " unix 0 "" shell rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed/file.1k.forbidden"
runtest "### rmdir     " unix 0 "" shell rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir.allowed/"
runtest "### touch sp  " unix 0 "" shell touch "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file\ 1"
runtest "### mv sp     " unix 0 "" shell mv "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file\ 1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file\ 2"
runtest "### stat sp   " unix 1 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file\ 1"
runtest "### stat sp   " unix 0 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file\ 2"
runtest "### rm sp     " unix 0 "" shell rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/file\ 2"
runtest "### FUSE mkdr " unix 0 "" eos mkdir -p "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/"
runtest "### FUSE mkdr " unix 0 "" mkdir -p "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir1/"
runtest "### FUSE lnk  " unix 0 "" shell ln -s "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/link1"
runtest "### FUSE lnk  " unix 0 "" shell ln -s "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/link1"
runtest "### FUSE lnk  " unix 1 "" shell ln -s "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/link1"
runtest "### FUSE mkdr " unix 0 "" shell mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/link1/dir2"
runtest "### FUSE stat " unix 0 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/link1/dir2"
runtest "### FUSE stat " unix 0 "" shell stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/fuse/dir1/dir2"
fi

################################################################################
# Third party copy tests
################################################################################
# ------------------------------------------------------------------------------
categorie="tpc"
# ------------------------------------------------------------------------------
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc"
runtest "### Upload    " unix 0 "" upload    "$TESTSYSFILE1K" "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.1"
if [ ${XRD4} -eq 1 ]; then
runtest "### TPC 1     " unix 0 "" tpc1 "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.2"
else
runtest "### TPC 1     " unix 0 "" tpc2 "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.2"
fi
runtest "### TPC 2     " unix 0 "" tpc2 "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.1" "/eos/$EOS_TEST_INSTANCE/test/instancetest/tpc/file.tpc.3"
runtest "### Rm        " unix 0 "" eos rm -r /eos/$EOS_TEST_INSTANCE/test/instancetest/tpc

################################################################################
# Versioning tests
################################################################################
# ------------------------------------------------------------------------------
categorie="versioning"
# ------------------------------------------------------------------------------
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning"
runtest "### Chmod     " unix 0 "" eos chmod "777" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning"
runtest "### Mkdir     " unix 0 "EOSROLE='-r 99 99'" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.bla"
runtest "### Attr Ls   " unix 0 "EOSROLE='-r 99 99'" eos attr ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.bla | wc -l | grep -w 0"
runtest "### Rmdir     " unix 0 "EOSROLE='-r 99 99'" eos rmdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.bla"
runtest "### Attr Set  " unix 0 "" eos attr set sys.versioning=3 /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd | wc -l | grep -w 3"
runtest "### File Vers." unix 0 "EOSROLE='-r 99 99'" eos file version /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd 99
runtest "### File Vers." unix 0 "EOSROLE='-r 99 99'" eos file version /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd 99
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd | wc -l | grep -w 5"
runtest "### File Vers." unix 0 "EOSROLE='-r 99 99'" eos file purge /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd 4
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd | wc -l | grep -w 4"
runtest "### File Vers." unix 0 "EOSROLE='-r 99 99'" eos file purge /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd -1
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd | wc -l | grep -w 3"
runtest "### File Vers." unix 0 "EOSROLE='-r 99 99'" eos file purge /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd 0
runtest "### Stat      " unix 1 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd"
runtest "### Rm        " unix 0 "EOSROLE='-r 99 99'" eos rm "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Stat      " unix 1 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Upload    " unix 0 "EOSROLE='-r 99 99'" eos cp "/etc/passwd" "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/passwd"
runtest "### Find Purge" unix 0 "EOSROLE='-r 99 99'" eos find --purge -1 /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd | wc -l | grep -w 3"
runtest "### Find Purge" unix 0 "EOSROLE='-r 99 99'" eos find --purge 2 /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/
runtest "### Ls        " unix 0 "EOSROLE='-r 99 99'" eos ls "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd | wc -l | grep -w 2"
runtest "### Find Purge" unix 0 "EOSROLE='-r 99 99'" eos find --purge 0 /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/
runtest "### Stat      " unix 1 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/versioning/.sys.v#.passwd"
runtest "### Cleanup"    unix 2 "" eos rm  "-r /eos/$EOS_TEST_INSTANCE/test/instancetest/versioning"

################################################################################
# HTTP tests
################################################################################
# ------------------------------------------------------------------------------
categorie="http"
# ------------------------------------------------------------------------------
HTTPDIR=eos/$EOS_TEST_INSTANCE/test/instancetest/http.dir
runtest "### Mkdir        " unix 0 "" eos mkdir $HTTPDIR
runtest "### Chmod        " unix 0 "" eos chmod 777 $HTTPDIR
runtest "### Http PUT     " unix 0 "" curl --location --fail --silent --upload-file $TESTSYSFILE50M http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m
runtest "### Http GET     " unix 0 "" curl --location --fail --silent http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpit
runtest "### Chmod        " unix 0 "" eos chmod 644 $HTTPDIR
runtest "### Http PUT     " unix 1 "" curl --location --fail --silent --upload-file $TESTSYSFILE50M http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m
runtest "### Http GET     " unix 1 "" curl --location --fail --silent http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpit
runtest "### Chmod        " unix 0 "" eos chmod 777 $HTTPDIR

# --------------------------
# Range requests
# --------------------------
runtest "### Http GET     " unix 0 "" curl --location --fail --silent --range 0-499 http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpit
runtest "### Http GET     " unix 0 "" curl --location --fail --silent --range 0-499,500-999 http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpit
runtest "### Http GET     " unix 0 "" curl --location --fail --silent --range 0-499,1000-1499 http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpi
runtest "### Http GET     " unix 0 "" curl --location --fail --silent --range 50000000- http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpit
runtest "### Http GET     " unix 1 "" curl --location --fail --silent --range 51200000-512000000 http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR/file.50m --output $EOS_TEST_TESTSYS/dumpit
runtest "### HttpXUpload  " unix 0 "" eos attr set sys.forced.checksum=adler $HTTPDIR
runtest "### HttpXUpload  " unix 0 "" shell eos-http-upload-test rangeupload multipartfile /$HTTPDIR/
################################################################################
# WebDAV tests
################################################################################
# ------------------------------------------------------------------------------
categorie="dav"
# ------------------------------------------------------------------------------
runtest "### WebDAV Ls    " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR     <<< ls"
runtest "### WebDAV Ls    " unix 0 "" tgrep "404"       "cadaver http://$EOS_TEST_REDIRECTOR:8000$HTTPDIR/foo  <<< ls"
runtest "### WebDAV Mkdir " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR     <<< \"mkdir sub.dir\""
runtest "### WebDAV Ls    " unix 0 "" tgrep "sub.dir"   "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR     <<< ls"
runtest "### WebDAV Mkdir " unix 0 "" tgrep "409"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR     <<< \"mkdir foo/bar/sub.dir\""

# Disable overwrite
echo "unset overwrite" > $EOS_TEST_TESTSYS/.cadaverrc
runtest "### WebDAV Copy  " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"copy file.50m file.50m.copy\""
runtest "### WebDAV Copy  " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"copy file.50m file.50m.copy\""
runtest "### WebDAV Copy  " unix 0 "" tgrep "403"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"copy file.50m file.50m\""
runtest "### WebDAV Copy  " unix 0 "" tgrep "409"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"copy file.50m foo/bar/file.50m\""
runtest "### WebDAV Copy  " unix 0 "" tgrep "412"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR --rcfile=$EOS_TEST_TESTSYS/.cadaverrc <<< \"copy file.50m file.50m.copy\""
runtest "### WebDAV Move  " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"move file.50m file.50m.copy\""
runtest "### WebDAV Copy  " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"copy file.50m.copy file.50m\""
runtest "### WebDAV Move  " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"move file.50m file.50m.copy\""
runtest "### WebDAV Move  " unix 0 "" tgrep "403"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"move file.50m file.50m\""
runtest "### WebDAV Move  " unix 0 "" tgrep "409"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"move file.50m foo/bar/file.50m\""
runtest "### WebDAV Copy  " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"copy file.50m.copy file.50m\""
runtest "### WebDAV Move  " unix 0 "" tgrep "412"       "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR --rcfile=$EOS_TEST_TESTSYS/.cadaverrc <<< \"move file.50m.copy file.50m\""
runtest "### WebDAV Rm    " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"rm file.50m\""
runtest "### WebDAV Rm    " unix 0 "" tgrep "succeeded" "cadaver http://$EOS_TEST_REDIRECTOR:8000/$HTTPDIR <<< \"rmcol sub.dir\""

################################################################################
# Amazon S3 tests
################################################################################
# ------------------------------------------------------------------------------
categorie="s3"
# ------------------------------------------------------------------------------
export S3_ACCESS_KEY_ID="s3user"
export S3_SECRET_ACCESS_KEY="0123456789"
export S3_HOSTNAME=$EOS_TEST_REDIRECTOR

#----------------------------------------------------------------------------
# Prepare the setup for S3 tests
#----------------------------------------------------------------------------
runtest "### Prepare user " unix 0 "" shell adduser -M s3user
runtest "### Prepare dir  " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/s3.dir"
runtest "### Prepare mod  " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/s3.dir"

runtest "### S3 Attr      " unix 0 "" eos attr set sys.s3.bucket.s3user="test" /eos/$EOS_TEST_INSTANCE/proc
runtest "### S3 Attr      " unix 0 "" eos attr set sys.s3.id.s3user="0123456789" /eos/$EOS_TEST_INSTANCE/proc
runtest "### S3 Attr      " unix 0 "" eos attr set sys.s3.path.test="/eos/$EOS_TEST_INSTANCE/test/instancetest/s3.dir" /eos/$EOS_TEST_INSTANCE/proc

# ------------------------------------------------------------------------------
runtest "### S3 List      " unix 0 "" davix-ls  --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/test/
runtest "### S3 Upload    " unix 0 "" davix-put --s3accesskey s3user --s3secretkey 0123456789 --s3alternate $TESTSYSFILE50M s3://$EOS_TEST_REDIRECTOR:8000/test/file.50m
runtest "### S3 List      " unix 0 "" davix-ls  --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/test
runtest "### S3 Download  " unix 0 "" davix-get --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/test/file.50m file.50m
runtest "### S3 Rm        " unix 0 "" davix-rm  --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/test/file.50m
runtest "### S3 List      " unix 0 "" davix-ls  --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/test/
runtest "### S3 Download  " unix 1 "" davix-get --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/test/file.50m
runtest "### S3 List      " unix 1 "" davix-ls  --s3accesskey s3user --s3secretkey 0123456789 --s3alternate s3://$EOS_TEST_REDIRECTOR:8000/otherdir/

#----------------------------------------------------------------------------
# Clean up the files created in S3 tests
#----------------------------------------------------------------------------
runtest "### Cleanup   " unix 0 "" shell userdel s3user
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/s3.dir"
runtest "### Cleanup   " unix 2 "" shell rm -f file.50m

################################################################################
# Owncloud tests
################################################################################
# ------------------------------------------------------------------------------
categorie="owncloud"
# ------------------------------------------------------------------------------
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc"
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc"
runtest "### Attr Set  " unix 0 "" eos attr set default=replica "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc"

# upload with chunking
runtest "### OcChunk   " unix 0 "" shell eos-oc-test chunkedupload chunked /eos/$EOS_TEST_INSTANCE/test/instancetest/oc/

# check it exists
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc/chunked"
runtest "### OcChunk   " unix 1 "" shell eos-oc-test chunkedupload chunked
# upload again
runtest "### OcChunk   " unix 0 "" shell eos-oc-test chunkedupload chunked /eos/$EOS_TEST_INSTANCE/test/instancetest/oc/
# check that there is no version
runtest "### Stat      " unix 1 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc/.sys.v#.chunked/"
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc/chunked"
# enable versioning
runtest "### Attr Set  " unix 0 "" eos attr set sys.versioning=2 /eos/$EOS_TEST_INSTANCE/test/instancetest/oc/
runtest "### OcChunk   " unix 0 "" shell eos-oc-test chunkedupload chunked /eos/$EOS_TEST_INSTANCE/test/instancetest/oc/
runtest "### OcChunk   " unix 0 "" shell eos-oc-test chunkedupload chunked /eos/$EOS_TEST_INSTANCE/test/instancetest/oc/
# check that versions are kept as expected
runtest "### Stat      " unix 0 "" meta stat "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc/.sys.v#.chunked/"
runtest "### Find      " unix 0 "" eos find "-f --count /eos/$EOS_TEST_INSTANCE/test/instancetest/oc | grep nfiles=3"

#----------------------------------------------------------------------------
# Clean up the files created in owncloud tests
#----------------------------------------------------------------------------
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/oc"

################################################################################
# RAIN-LIKE LAYOUT TESTS FOR WR/RD AND RECOVERY
# !!!RUN ONLY IF AT LEAST 6 FSTs PRESENT!!!
################################################################################
# ------------------------------------------------------------------------------
categorie="rain"
# ------------------------------------------------------------------------------
NUM_FST=$($XROOTSYS/bin/eos -b $EOSROLE fs ls | awk '{ if (($6 ~ /booted/) || ($7 ~ /booted/)) c++} END {print c}')
if [ $NUM_FST -ge 6 ]; then
   # Create temporary RAIN test file outside EOS
   export EOS_TEST_RAIN_TMP=/tmp/rain_test
   mkdir -p $EOS_TEST_RAIN_TMP

   # Create the RAIDDP directory and set the proper attributes
   runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.checksum=crc32c "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.blockchecksum=crc32c "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.blocksize=1M "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.layout=raiddp "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.nstripes=6 "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"

   # Create the RAID6 directory and set the proper attributes
   runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.checksum=crc32c "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.blockchecksum=crc32c "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.blocksize=1M "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.layout=raid6 "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   runtest "### Attr      " unix 0 "" eos attr set sys.forced.nstripes=6 "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"

   runtest "### RaiddpTest " unix 0 "" eos_rain "raiddp" "$EOS_TEST_RAIN_DIR" "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp" "$EOS_TEST_RAIN_TMP"
   # Sleep two seconds between the tests as disabling/enabling a FST is not that fast
   sleep 2
   runtest "### Raid6Test  " unix 0 "" eos_rain "raid6" "$EOS_TEST_RAIN_DIR" "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6" "$EOS_TEST_RAIN_TMP"
   sleep 2

   # Run the eos-io-test for sequential and non-streaming IO against the RAIN
   # directories
   runtest "### EosIoRaiddp  " unix 0 "" eos_io "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp" "$EOS_TEST_RAIN_DIR"
   runtest "### EosIoRaid6   " unix 0 "" eos_io "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6" "$EOS_TEST_RAIN_DIR"

   # Clean up the files used for the RAIN test
   runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/raiddp"
   runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest/raid6"
   rm -rf $EOS_TEST_RAIN_TMP
else
  echo "Can not run RAIN test - not enough FSTs!"
fi

#-------------------------------------------------------------------------------
# Create PLAIN directory and set the attributes for the eoscp-rain-test
# Add a file used for testing - this test can be done with just one FST
#-------------------------------------------------------------------------------
runtest "### Mkdir     " unix 0 "" eos mkdir "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.checksum=crc32c "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.blockchecksum=crc32c "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.blocksize=1M "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.layout=plain "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir"
runtest "### Upload    " unix 0 "" upload "$EOS_TEST_RAIN_DIR/file3.rain" "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir/file.dat"
runtest "### EoscpRaiddp " unix 0 "" eoscp_rain "raiddp" "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir/file.dat"
runtest "### EoscpRaid6  " unix 0 "" eoscp_rain "reeds" "/eos/$EOS_TEST_INSTANCE/test/instancetest/eoscp_rain_dir/file.dat"
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/eoscp_rain_dir"

################################################################################
# FST tests with plain and raid layouts
################################################################################
runtest "### Mkdir     " unix 0 "" eos mkdir "-p" "/eos/dev/test/fst/plain"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/dev/test/fst/plain"
runtest "### Mkdir     " unix 0 "" eos mkdir "-p" "/eos/dev/test/fst/raiddp"
runtest "### Chmod     " unix 0 "" eos chmod 777 "/eos/dev/test/fst/raiddp"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.layout=plain "/eos/dev/test/fst/plain"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.checksum=adler "/eos/dev/test/fst/plain"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.nstripes=1 "/eos/dev/test/fst/plain"
runtest "### Attr      " unix 0 "" eos attr set sys.forced.space=default "/eos/dev/test/fst/plain"
runtest "### Attr      " unix 0 "" eos attr set default=raiddp "/eos/dev/test/fst/raiddp"

TMP_FILE_32MB=mktemp
dd if=/dev/zero count=32 bs=1M | tr '\000' '\001' > $TMP_FILE_32MB
xrdcp -f -d 1 $TMP_FILE_32MB root://$EOS_TEST_REDIRECTOR//eos/dev/test/fst/plain/file32MB.dat
xrdcp -f -d 1 $TMP_FILE_32MB root://$EOS_TEST_REDIRECTOR//eos/dev/test/fst/raiddp/file32MB.dat

runtest "### Fst       " unix 0 "" eos-fst-test
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/dev/test/fst"

################################################################################
# OTHER TESTS
################################################################################
runtest "### Ls max input " unix 1 eos ls /file1/file2/file3/file4/file5/file6/file7/file8/file9/file10/file11/file12/file13/file14/file15/file16/file17/file18/file19/file20/file21/file22/file23/file24/file25/file26/file27/file28/file29/file30/file31/file32/file33/file34/file35/file36/file37/file38/file39/file40/file41/file42/file43/file44/file45/file46/file47/file48/file49/file50/file51/file52/file53/file54/file55/file56/file57/file58/file59/file60/file61/file62/file63/file64/file65/file66/file67/file68/file69/file70/file71/file72/file73/file74/file75/file76/file77/file78/file79/file80/file81/file82/file83/file84/file85/file86/file87/file88/file89/file90/file91/file92/file93/file94/file95/file96/file97/file98/file99/file100/file101/file102/file103/file104/file105/file106/file107/file108/file109/file110/file111/file112/file113/file114/file115/file116/file117/file118/file119/file120/file121/file122/file123/file124/file125/file126/file127/file128/file129/file130/file131/file132/file133/file134/file135/file136/file137/file138/file139/file140/file141/file142/file143/file144/file145/file146/file147/file148/file149/file150/file151/file152/file153/file154/file155/file156/file157/file158/file159/file160/file161/file162/file163/file164/file165/file166/file167/file168/file169/file170/file171/file172/file173/file174/file175/file176/file177/file178/file179/file180/file181/file182/file183/file184/file185/file186/file187/file188/file189/file190/file191/file192/file193/file194/file195/file196/file197/file198/file199/file200/file201/file202/file203/file204/file205/file206/file207/file208/file209/file210/file211/file212/file213/file214/file215/file216/file217/file218/file219/file220/file221/file222/file223/file224/file225/file226/file227/file228/file229/file230/file231/file232/file233/file234/file235/file236/file237/file238/file239/file240/file241/file242/file243/file244/file245/file246/file247/file248/file249/file250/file251/file252/file253/file254/file255/file256/file257/file258/file259/file260/file261/file262/file263/file264/file265/file266/file267/file268/file269/file270/file271/file272/file273/file274/file275/file276/file277/file278/file279/file280/file281/file282/file283/file284/file285/file286/file287/file288/file289/file290/file291/file292/file293/file294/file295/file296/file297/file298/file299/file300

################################################################################
# HEALTH
################################################################################
runtest "### Health    " unix 0 "" eos health "-m | grep \"default\.0\""

################################################################################
# FINAL CLEANUP
################################################################################
# ------------------------------------------------------------------------------
categorie="clean"
# ------------------------------------------------------------------------------
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/stress"
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/instancetest"
runtest "### Cleanup   " unix 2 "" eos rm "-r" "/eos/$EOS_TEST_INSTANCE/test/rain"
################################################################################
# show test summary
testout
unlink $EOSTESTPID
exit;
################################################################################
) | tee -a $EOSALLCERTLOG &

trap 'kill_processes' TERM
trap 'kill_processes' QUIT
trap 'kill_processes' INT

sleep 1
testpid=`cat $EOSTESTPID 2>/dev/null`;
for wait in `seq 1 $EOS_TEST_TESTTIMESLICE`; do
    kill -0 $testpid >& /dev/null
    if [ $? -eq 0 ]; then
        sleep 1;
    else
        break;
    fi
done

kill -0 $testpid >& /dev/null

if [ $? -eq 0 ]; then
 touch $TIMEOUTFILE
 kill_child_processes $testpid;
fi

[ -e "$TIMEOUTFILE" ] && ( echo >> $EOSALLCERTLOG; echo "error: timeout after $EOS_TEST_TESTTIMESLICE seconds" >> $EOSALLCERTLOG; touch $FAILFILE; echo "error: timeout after $EOS_TEST_TESTTIMESLICE seconds";)

unlink $TIMEOUTFILE >& /dev/null

################################################################################
echo "#--------------------------------------------------------------"
echo "# Log of the test results         : $EOSALLCERTLOG"
echo "# Log with individual test output : $EOSCERTLOG"
echo "#--------------------------------------------------------------"
################################################################################
mailnotify
################################################################################
